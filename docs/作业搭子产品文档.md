
# 📝 产品需求文档 (PRD)：作业搭子 (Homework Pal) v1.1

## 1. 项目概述
*   **产品名称**：作业搭子 (Homework Pal)
*   **核心定位**：基于国产大模型与 Chainlit 的、专为使用**人教版教材**的三年级学生设计的智能作业辅导 Agent。
*   **技术栈**：PostgreSQL (timescale-vector) + LangChain + Chainlit + 国产 LLM (Qwen/DeepSeek)。
*   **核心价值**：
    1.  **精准辅导**：基于人教版教材的 RAG，提供书本级的知识点溯源。
    2.  **闭环学习**：从作业检查到错题归档，形成完整的学习闭环。
    3.  **情绪价值**：以鼓励为主的交互风格，保护孩子的学习兴趣。

---

## 2. 用户角色 (User Personas)
*   **学生 (三年级)**：主要使用者。会用手机拍照，能进行简单的语音/文字对话。需求是“快点做完作业”和“遇到难题有人教”。
*   **家长**：辅助使用者/监督者。需求是“掌握孩子作业完成情况”和“查看错题本”。

---

## 3. 核心功能模块 (Functional Requirements)

### 3.1 知识库模块 (The Brain - RAG)
*   **数据源**：**暂仅限人教版 (PEP)** 三年级上/下册教材（语文、数学、英语）。
*   **数据处理**：
    *   **文本切片**：按“单元-课题-知识点”进行层级切分。
    *   **元数据 (Metadata)**：必须包含 `subject` (科目), `grade` (年级), `unit` (单元), `page` (页码)。
*   **检索逻辑**：
    *   混合搜索 (Hybrid Search)：关键词 (BM25) + 向量 (BGE-M3)。
    *   **溯源引用**：回答必须标注“参考人教版数学三年级上册 P35”。

### 3.2 视觉批改模块 (The Reviewer - Vision)
*   **输入**：支持上传单张或多张作业图片。
*   **处理流程 (Chainlit Steps)**：
    *   UI 显示折叠进度条：
        1.  `正在接收图片...`
        2.  `👀 正在识别手写字...` (调用 VLM)
        3.  `🧠 正在回顾课本知识...` (调用 RAG)
        4.  `✍️ 正在生成批改建议...`
*   **批改逻辑**：
    *   **判题**：识别对错。
    *   **引导**：错误题目**不给答案**，给出解题思路或反问。
    *   **关联**：错误题目自动关联 RAG 检索到的课本知识点。

### 3.3 错题本模块 (The Mistake Notebook)
*   **数据存储**：
    *   在 PostgreSQL 中建立 `mistakes` 表，字段包括：`task_id`, `original_image_crop` (错题截图路径), `student_answer`, `correct_hint`, `textbook_ref`, `created_at`。
*   **交互入口 (Chainlit)**：
    *   **指令触发**：输入 `/错题本` 或点击界面上的“错题本”按钮（Action）。
    *   **展示形式**：
        1.  **卡片流**：在聊天窗口发送最近 5 道错题的卡片（包含截图、知识点）。
        2.  **下载版**：生成一个 Markdown/PDF 文件链接，包含本周所有错题，排版整齐，供家长打印。
*   **复习模式**：
    *   用户点击某道错题卡片下的“我学会了”按钮 -> 数据库更新状态 -> 界面给予烟花特效奖励 🎉。

### 3.4 作业清单模块 (The Planner)
*   **输入**：家长转发的文字/语音/图片通知。
*   **输出**：结构化的 Markdown Checklist。
*   **状态同步**：完成一项打钩一项，进度条实时更新。

---

## 4. 交互设计 (UX/UI Design - Chainlit)

### 4.1 界面风格
*   **主题**：默认 Light Mode，字体清晰。
*   **欢迎语**：
    > 👋 嗨！我是你的作业搭子小栗子！🌰
    > 今天我们也要一起消灭作业怪兽哦！
    > 👇 你可以：
    > [📸 检查作业] [📅 整理清单] [📕 复习错题]

### 4.2 关键交互脚本

#### 场景：检查作业并发现错误
1.  **用户**：[上传图片]
2.  **系统**：[显示 Step 进度条 3-5秒]
3.  **系统**：
    > 哇，字写得很工整呢！👍
    > 我检查了一下，第 1、2 题都对啦！
    >
    > 但是 **第 3 题** 我们要再看一看：
    > [展示第 3 题切片图]
    > 题目问的是“周长”，你好像算成“面积”了。
    >
    > 💡 **小栗子提示**：
    > 记得课本 P42 说的吗？周长是围成图形一圈的长度。
    > [引用卡片：人教版数学 P42 定义]
    >
    > 你再算一次告诉我答案，好吗？
4.  **用户**：是 16 厘米！
5.  **系统**：
    > 答对啦！🎉 这种题以后要注意单位哦。
    > *（系统后台自动将该题存入错题本）*

#### 场景：查看错题本
1.  **用户**：点击下方 Action 按钮 [📕 我的错题本]
2.  **系统**：
    > 这一周我们一共收集了 **5** 道错题。
    > 主要集中在 **“长方形周长”** 这个单元。
    >
    > 📄 **点击下载打印版**：[2025-12-03-错题集.pdf]
    >
    > 或者我们现在复习第一道？
    > [展示错题卡片 1] [按钮：我学会了] [按钮：还需要提示]

---

## 5. 数据字典 (Database Schema 简述)

为了支持上述功能，你的 Postgres 数据库至少需要以下几张表：

1.  **`textbook_knowledge`** (RAG 核心)
    *   `content` (文本)
    *   `embedding` (向量)
    *   `metadata` (JSON: {subject: "math", version: "PEP", page: 42})

2.  **`homework_sessions`** (作业会话)
    *   `id`, `user_id`, `date`, `summary` (清单内容)

3.  **`mistake_records`** (错题本)
    *   `id`
    *   `session_id`
    *   `subject`
    *   `image_path` (错题截图)
    *   `ai_analysis` (AI 的分析文本)
    *   `textbook_ref_id` (关联的知识点 ID)
    *   `status` (0:未掌握, 1:已掌握)

---

## 6. 开发路线图 (Dev Roadmap)

*   **Phase 1: 基础架构 (Day 1-2)**
    *   搭建 Postgres + pgvector。
    *   跑通 Chainlit Hello World。
    *   接入国产 LLM/VLM API。
*   **Phase 2: 知识库构建 (Day 3)**
    *   处理人教版教材数据（这是最耗时的脏活，建议先搞定数学一本书作为 MVP）。
    *   实现 RAG 检索链路。
*   **Phase 3: 视觉与业务逻辑 (Day 4)**
    *   实现图片上传 -> VLM 识别 -> RAG 关联 -> 生成反馈的 Prompt 链。
    *   实现 Chainlit 的 Loading Step 效果。
*   **Phase 4: 错题本与交付 (Day 5)**
    *   实现错题入库逻辑。
    *   实现 `/错题本` 查询与展示逻辑。
    *   整体测试与 Prompt 调优（语气控制）。

---
